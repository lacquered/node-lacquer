extends layout_reservation

block content
    .section
        .container.container-border
            nav.navbar.navbar-ct-azure.navbar-fixed-top(role='navigation')
                .container.text-center
                    .navbar-header2
                        a.navbar-brand(href='/')
                            i.fa.fa-chevron-left
                        .titleBarTxt.text-center 조회 및 수정하기
    #resSearch
        .section
            .container.container-border
                br
                .row
                    .col-lg-12
                        .form-horizontal
                            .form-group
                                h5.col-xs-3.text-center(for='time') 출발지
                                .col-xs-9
                                    select#pSource.mobileSelect(data-title='출발지를 선택해주세요.')
                                        for item in listSource
                                            option(value='#{item}' selected=(pSource == item) ? true : false) #{item}
                            .form-group
                                h5.col-xs-3.text-center(for='date') 일 자
                                .col-xs-9
                                    div
                                        input#pDate.form-control.textBorder(type='text', placeholder='클릭하여 선택해 주세요.', data-value='#{pDate}')
                            .form-group
                                h5.col-xs-3.text-center(for='time') 시 간
                                .col-xs-9
                                    select#pTime.mobileSelect(data-title='출발 시간을 선택해주세요.')
                                        for item in listTime
                                            option(value='#{item}' selected=(pTime == item) ? true : false) #{item}
                            .form-group
                                h5.col-xs-3.text-center(for='time') 전화번호
                                .col-xs-9
                                    .col-xs-4(style='padding-right: 4px; padding-left: 0px;')
                                        input#pTel1.form-control.textBorder(type='text', pattern='\d*', maxlength='3', style='ime-mode:disabled;', value='#{pTel1}')
                                    .col-xs-4(style='padding-right: 2px; padding-left: 2px;')
                                        input#pTel2.form-control.textBorder(type='number', pattern='[0-9]{10}', step='1', maxlength='4', value='#{pTel2}')
                                    .col-xs-4(style='padding-right: 0px; padding-left: 4px;')
                                        input#pTel3.form-control.textBorder(type='number', maxlength='4', style='ime-mode:disabled;', value='#{pTel3}')
                            .form-group
                                .text-center
                                    button#btnRetrieve.btn.btn-primary.btn-lg.btn-fill.btn-round(type='button')
                                        | 조 회 하 기
    #resInfo
        .section
            .container
                .col-lg-12
                    .form-horizontal
                        .form-group
                            h5.col-xs-3.text-center 출발지
                            .col-xs-9
                                h5#infoSource
                        .form-group
                            h5.col-xs-3.text-center 일 자
                            .col-xs-9
                                h5#infoDate
                        .form-group
                            h5.col-xs-3.text-center 시 간
                            .col-xs-9
                                h5#infoTime
                        .form-group
                            h5.col-xs-3.text-center 전화번호
                            .col-xs-9
                                h5#infoTel
                        .form-group
                            h5.col-xs-3.text-center 예약자
                            .col-xs-9
                                input#pName.form-control.textBorder(type='text')
        .section.section-gray.section-faq
            .container
                h3.section-title 여객선 예약
                .row
                    .col-lg-12
                        .col-xs-3
                            h5.text-center 성인
                            select#pFerryCnt1.mobileSelect.cntSelect(width='100%', data-title='성인')
                                - for (var x = 0; x <= 50; x++)
                                    option(value='#{x}') #{x}
                        .col-xs-3
                            h5.text-center 청소년
                            select#pFerryCnt2.mobileSelect.cntSelect(width='100%', data-title='청소년 : 중고등학생')
                                - for (var x = 0; x <= 50; x++)
                                    option(value='#{x}') #{x}
                        .col-xs-3
                            h5.text-center 소인
                            select#pFerryCnt3.mobileSelect.cntSelect(width='100%', data-title='소인 : 만3세 ~ 초등학생')
                                - for (var x = 0; x <= 50; x++)
                                    option(value='#{x}') #{x}
                        .col-xs-3
                            h5.text-center 유아
                            select#pFerryCnt4.mobileSelect.cntSelect(width='100%', data-title='유아 : 0 ~ 만2세')
                                - for (var x = 0; x <= 50; x++)
                                    option(value='#{x}') #{x}
        .section.section-gray.section-faq
            .container
                h3.section-title 식사 예약
                .row
                    .col-lg-12
                        .col-xs-6
                            h5.text-center 메뉴 1 번
                            select#pLunchCnt1.mobileSelect.cntSelect(width='100%', data-title='메뉴 1 번')
                                - for (var x = 0; x <= 50; x++)
                                    option(value='#{x}') #{x}
                        .col-xs-6
                            h5.text-center 메뉴 2 번
                            select#pLunchCnt2.mobileSelect.cntSelect(width='100%', data-title='메뉴 2 번')
                                - for (var x = 0; x <= 50; x++)
                                    option(value='#{x}') #{x}
        .container
            br
            br
            .text-center
                button#btnSave.btn.btn-primary.btn-fill.btn-round(type='button')
                    | 저장하기
                &nbsp;
                button#btnDelete.btn.btn-danger.btn-fill.btn-round(type='button')
                    | 삭제하기
                &nbsp;
                button#btnCancel.btn.btn-default.btn-fill.btn-round(type='button')
                    | &nbsp;&nbsp;취 소&nbsp;&nbsp;

    script(src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js')
    script(src='../libs/bootstrap/js/bootstrap.min.js')
    script(src='../libs/pickadate/js/picker.js')
    script(src='../libs/pickadate/js/picker.date.js')
    script(src='../libs/pickadate/js/picker.time.js')
    script(src='../libs/pickadate/js/ko_KR.js')
    script(src='../libs/fullscreenSelect/js/bootstrap-fullscreen-select.min.js')
    script.

        $('#resInfo').hide();

        var $pDate = $('#pDate').pickadate({
            min: true
        }), pDate = $pDate.pickadate('picker');

        $.mobileSelect.defaults = {
            buttonSave: '선택',
            buttonCancel: '취소',
            theme: 'white',
            onOpen: function () {
            },
            onClose: function () {
            },
            style: 'btn-default'
        };
        $('.mobileSelect').mobileSelect();


        $('#btnRetrieve').click(function () {

            var _data = {
                source: $('#pSource').val(),
                date: pDate.get('select', 'yyyymmdd'),
                time: $('#pTime').val(),
                tel1: $('#pTel1').val(),
                tel2: $('#pTel2').val(),
                tel3: $('#pTel3').val()
            }

            if (!_data.date) {
                alert('날짜를 입력하세요.');
                return;
            }
            if (!_data.tel1 || !_data.tel2 || !_data.tel3) {
                alert('전화번호를 입력하세요.');
                return;
            }

            $("#btnRetrieve").prop("disabled", true);

            $.ajax({
                url: '/reservation/retrieve', type: "POST", data: _data, dataType: 'json'
            }).done(function (data) {

                if (data.status == 'NOTEXISTED') {
                    alert('해당하는 예약 정보가 없습니다.');
                    $("#btnRetrieve").prop("disabled", false);
                    return;
                } else {
                    $("#btnRetrieve").prop("disabled", false);
                    $('#resSearch').hide();
                    $('#resInfo').show();

                    $('#infoSource').text(data.result.source);
                    $('#infoDate').text(pDate.get());
                    $('#infoTime').text(data.result.time);
                    $('#infoTel').text(data.result.tel1+' - '+data.result.tel2+' - '+data.result.tel3);

                    $('#pName').val(data.result.name);
                    $('#pFerryCnt1').find('option[value="' + data.result.ferryCnt1 + '"]').attr("selected", "true");
                    $('#pFerryCnt1').mobileSelect('refresh');
                    $('#pFerryCnt2').find('option[value="' + data.result.ferryCnt2 + '"]').attr("selected", "true");
                    $('#pFerryCnt2').mobileSelect('refresh');
                    $('#pFerryCnt3').find('option[value="' + data.result.ferryCnt3 + '"]').attr("selected", "true");
                    $('#pFerryCnt3').mobileSelect('refresh');
                    $('#pFerryCnt4').find('option[value="' + data.result.ferryCnt4 + '"]').attr("selected", "true");
                    $('#pFerryCnt4').mobileSelect('refresh');

                    $('#pLunchCnt1').find('option[value="' + data.result.lunchCnt1 + '"]').attr("selected", "true");
                    $('#pLunchCnt1').mobileSelect('refresh');
                    $('#pLunchCnt2').find('option[value="' + data.result.lunchCnt2 + '"]').attr("selected", "true");
                    $('#pLunchCnt2').mobileSelect('refresh');

                }

            }).fail(function () {
                $("#btnRetrieve").prop("disabled", false);
                alert('서버 장애가 발생하였습니다.\n(전화 문의 1661-4428)');
            });

        });


        $('#btnCancel').click(function () {
            $('#resSearch').show();
            $('#resInfo').hide();
        });

        $('#btnSave').click(function () {

            var _data = {
                source: $('#pSource').val(),
                date: pDate.get('select', 'yyyymmdd'),
                time: $('#pTime').val(),
                tel1: $('#pTel1').val(),
                tel2: $('#pTel2').val(),
                tel3: $('#pTel3').val(),
                name: $('#pName').val(),
                ferryCnt1: $('#pFerryCnt1').val(),
                ferryCnt2: $('#pFerryCnt2').val(),
                ferryCnt3: $('#pFerryCnt3').val(),
                ferryCnt4: $('#pFerryCnt4').val(),
                lunchCnt1: $('#pLunchCnt1').val(),
                lunchCnt2: $('#pLunchCnt2').val()
            };

            if (!_data.name) {
                alert('예약자 성함을 입력하세요.');
                return;
            }
            if((_data.ferryCnt1 + _data.ferryCnt2 + _data.ferryCnt3 + _data.ferryCnt4 + _data.lunchCnt1 + _data.lunchCnt2) <= 0) {
                alert('여객선 탐승인원과 점심식사 인원 중 하나는 반드시 입력하셔야 합니다.');
                return;
            }

            $( "#btnSave" ).prop( "disabled", true );

            $.ajax({
                url: '/reservation/update', type: "POST", data: _data, dataType: 'json'
            }).done(function (result) {

                alert('수정 완료되었습니다.\n(전화 문의 1661-4428)');
                window.location.href = "/";

            }).fail(function () {
                $( "#btnSave" ).prop( "disabled", false );
                alert('서버 장애가 발생하였습니다.\n(전화 문의 1661-4428)');
            });

        });

        $('#btnDelete').click(function () {
            var _data = {
                source: $('#pSource').val(),
                date: pDate.get('select', 'yyyymmdd'),
                time: $('#pTime').val(),
                tel1: $('#pTel1').val(),
                tel2: $('#pTel2').val(),
                tel3: $('#pTel3').val()
            };

            $( "#btnDelete" ).prop( "disabled", true );

            $.ajax({
                url: '/reservation/delete', type: "POST", data: _data, dataType: 'json'
            }).done(function (result) {

                alert('삭제 완료되었습니다.\n(전화 문의 1661-4428)');
                window.location.href = "/";

            }).fail(function () {
                $( "#btnDelete" ).prop( "disabled", false );
                alert('서버 장애가 발생하였습니다.\n(전화 문의 1661-4428)');
            });

        });

